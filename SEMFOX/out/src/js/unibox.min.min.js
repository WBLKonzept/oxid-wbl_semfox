(function(b){b.fn.unibox=function(a){var e=this;var f=b.extend({suggestUrl:"",queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,extraHtml:undefined,minChars:3,maxWidth:e.outerWidth()},a);UniBox.init(e,f);return this}}(jQuery));var UniBox=function(){var O=-1;var J;var x;var A="";var F;var N=[];var M=true;var Q;var y=300;var G="";var E=2;var H;var C=[];var D="all";var P=-1;function K(b){if(b!==undefined){var a=J.val();if(b.keyCode==9||b.keyCode==13||a.length<E){x.slideUp(y);O=-1}}else{x.slideUp(y);O=-1}}function L(a,b){var c=null;return function(){var d=this,e=arguments;clearTimeout(c);c=window.setTimeout(function(){a.apply(d,e)},b||50)}}function z(a,b){if(!M){return a}var c=b.split(" ");var d={};$.each(c,function(e,f){if(f.length<2){return}a=a.replace(new RegExp(f,"gi"),"##"+e+"##");d["##"+e+"##"]="<span>"+f+"</span>"});$.each(d,function(e,f){a=a.replace(new RegExp(e,"gi"),f)});return a}function w(a){if(P==13){K();return}var b=J.val();x.html("");$.each(a.suggests,function(d,e){if(d.replace(/_/,"").length>0&&e.length>0){var c=$("<h4>"+d+"</h4>");x.append(c)}$.each(e,function(k,m){var n='<div class="unibox-selectable">';if(m.image!=undefined){n+='<div class="unibox-selectable-img-container"><img src="'+m.image+'"/></div>'}if(m.link!=undefined){n+='<a href="'+m.link+'">';n+=z(m.name,b);n+="</a>"}else{n+="<span>"+z(m.name,b)+"</span>"}console.log(Q);if(Q!=undefined){var l=Q.match(/##(.*?)##/gi);var o=Q;var f=false;for(var g in l){var p=l[g].replace(/#/g,"");var h=m[p];if(h==undefined){f=true;continue}var i=new RegExp(l[g],"g");o=o.replace(i,h)}if(!f){n+='<div class="unibox-extra">'+o+"</div>"}}n+='<div class="unibox-ca"></div></div>';var j=$(n);x.append(j)})});$(".unibox-selectable").click(function(){var d=$(this).find("span").text();J.val(d);var e=undefined;try{e=$(this).find("a").attr("href")}catch(c){}H(d,e);K()});$(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(a.words.length>0&&G.length>0&&(D=="all"||D=="bottom")){x.append("<h4>"+G+"</h4>")}$.each(a.words,function(e,d){if((D=="all"||D=="bottom")){if(d.overlayImage!=undefined){x.append('<img class="unibox-vis" src="'+d.overlayImage+'" style="background-image: url(\''+d.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{x.append('<img class="unibox-vis" src="'+d.image+'">')}}var g=$("#unibox-invisible");g.html(b.replace(new RegExp(d.name,"gi"),"<span>"+d.name+"</span>"));if((D=="all"||D=="top")&&jQuery.inArray(d.image,C)==-1){var c=$("#unibox-invisible span")[0];if(c!=undefined&&d.name.length>0){var f=$(c).position().left;visImage=$('<div class="unibox-ivf"><img src="'+d.image+'" alt="'+d.name+'"></div>');visImage.css("left",J.offset().left+f-10);visImage.css("top",J.offset().top-80);$("body").append(visImage);setTimeout(function(){$(".unibox-ivf").find("img").addClass("l")},10)}C.push(d.image)}});$("img").error(function(){$(this).hide()});x.css("left",J.offset().left);x.css("top",J.offset().top+J.outerHeight());x.slideDown(y,function(){x.css("left",J.offset().left);x.css("top",J.offset().top+J.outerHeight())});N=$(".unibox-selectable");O=-1}function R(){C=[];$(".unibox-ivf").remove()}function I(e){if(J.val().length<=1){R()}if(e.keyCode!=38&&e.keyCode!=40&&e.keyCode!=13){if(e.keyCode==46||e.keyCode==8){R()}return}if(e.keyCode==38&&O>0){O--}else{if(e.keyCode==40){O++}}if(N.length>0&&O>-1){O=O%N.length;N.removeClass("active");var b=$(N[O]);b.addClass("active")}if(e.keyCode==13){if(H!=undefined){var a=J.val();var c=undefined;if(O!=-1){a=$($(".unibox-selectable.active span")[0]).text();J.val(a);try{c=$($(".unibox-selectable.active")[0]).find("a").attr("href")}catch(d){}}H(a,c)}else{if(O!=-1){window.location.href=$($(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function B(b){P=b.keyCode;if(b.keyCode==38||b.keyCode==40||b.keyCode==13){return}var a=J.val();if(a.length>=E){$.ajax(A+encodeURIComponent(a),{dataType:"json",success:function(c){w(c)}})}}return{init:function(c,b){J=c;M=b.highlight;Q=b.extraHtml;A=b.suggestUrl;F=b.throttleTime;y=b.animationSpeed;E=b.minChars;H=b.enterCallback;D=b.instantVisualFeedback;G=b.queryVisualizationHeadline;J.attr("autocomplete","off");x=$('<div id="unibox-suggest-box"></div>');$("body").append(x);x.css("min-width",J.outerWidth());x.css("max-width",b.maxWidth);J.keydown(I);J.keydown(L(B,F));J.keydown(K);J.keyup(K);$("html").click(function(){x.slideUp(y)});x.click(function(d){d.stopPropagation()});var a=$('<div id="unibox-invisible">text whatever <span>this one</span></div>');J.parent().append(a)}}}();